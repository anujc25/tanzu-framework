apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: VSphereClusterTemplate
metadata:
  name: '${ CLUSTER_NAME }-infrastructure'
  namespace: '${ NAMESPACE }'
spec:
  template:
    spec:
      controlPlaneEndpoint:
        host: '${VSPHERE_CONTROL_PLANE_ENDPOINT}'
        port: 6443
      identityRef:
        kind: Secret
        name: '${ CLUSTER_NAME }'
      server: '${ VSPHERE_SERVER }'
      thumbprint: '${ VSPHERE_TLS_THUMBPRINT }'
---
apiVersion: cluster.x-k8s.io/v1beta1
kind: Cluster
metadata:
  name: ${CLUSTER_NAME}
  labels:
    tkg.tanzu.vmware.com/cluster-name: '${ CLUSTER_NAME }'
spec:
  clusterNetwork:
    pods:
      cidrBlocks: ["${CLUSTER_CIDR}"]
    services:
      cidrBlocks: ["${SERVICE_CIDR}"]
  topology:
    class: tkg-cluster-class-dev
    version: v1.21.2
    controlPlane:
      replicas: ${CONTROL_PLANE_MACHINE_COUNT}
    workers:
      machineDeployments:
      - class: tkg-worker
        name: tkg-worker-pool
        replicas: ${WORKER_MACHINE_COUNT}
    variables:
    - name: VSPHERE_CONTROL_PLANE_ENDPOINT
      value: "${VSPHERE_CONTROL_PLANE_ENDPOINT}"
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: VSphereMachineTemplate
metadata:
  name: '${ CLUSTER_NAME }-control-plane'
  namespace: '${ NAMESPACE }'
spec:
  template:
    spec:
      cloneMode: '${ VSPHERE_CLONE_MODE }'
      datacenter: '${ VSPHERE_DATACENTER }'
      datastore: '${ VSPHERE_DATASTORE }'
      storagePolicyName: '${ VSPHERE_STORAGE_POLICY_ID }'
      diskGiB: ${VSPHERE_CONTROL_PLANE_DISK_GIB}
      folder: '${ VSPHERE_FOLDER }'
      memoryMiB: ${VSPHERE_CONTROL_PLANE_MEM_MIB}
      network:
        devices:
        - dhcp4: true
          networkName: '${ VSPHERE_NETWORK }'
      numCPUs: ${ VSPHERE_CONTROL_PLANE_NUM_CPUS }
      resourcePool: '${ VSPHERE_RESOURCE_POOL }'
      server: '${ VSPHERE_SERVER }'
      template: '${ VSPHERE_TEMPLATE }'
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: VSphereMachineTemplate
metadata:
  name: '${ CLUSTER_NAME }-worker'
  namespace: '${ NAMESPACE }'
spec:
  template:
    spec:
      cloneMode: '${ VSPHERE_CLONE_MODE }'
      datacenter: '${ VSPHERE_DATACENTER }'
      datastore: '${ VSPHERE_DATASTORE }'
      storagePolicyName: '${ VSPHERE_STORAGE_POLICY_ID }'
      diskGiB: ${VSPHERE_WORKER_DISK_GIB}
      folder: '${ VSPHERE_FOLDER }'
      memoryMiB: ${VSPHERE_WORKER_MEM_MIB}
      network:
        devices:
        - dhcp4: true
          networkName: '${ VSPHERE_NETWORK }'
      numCPUs: ${ VSPHERE_WORKER_NUM_CPUS }
      resourcePool: '${ VSPHERE_RESOURCE_POOL }'
      server: '${ VSPHERE_SERVER }'
      template: '${ VSPHERE_TEMPLATE }'
---
apiVersion: controlplane.cluster.x-k8s.io/v1beta1
kind: KubeadmControlPlaneTemplate
metadata:
  name: '${ CLUSTER_NAME }-control-plane'
  namespace: '${ NAMESPACE }'
spec:
  template:
    spec:
      machineTemplate:
        infrastructureRef:
          apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
          kind: VSphereMachineTemplate
          name: '${ CLUSTER_NAME }-control-plane'
      kubeadmConfigSpec:
        useExperimentalRetryJoin: true
        clusterConfiguration:
          imageRepository: '${ _TKG_K8S_IMAGE_REPOSITORY }'
          etcd:
            local:
              dataDir: /var/lib/etcd
              imageRepository: '${ _TKG_ETCD_IMAGE_REPOSITORY }'
              imageTag: '${ _TKG_ETCD_IMAGE_TAG }'
              extraArgs:
                cipher-suites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
          dns:
            imageRepository: '${ _TKG_COREDNS_IMAGE_REPOSITORY }'
            imageTag: '${ _TKG_COREDNS_IMAGE_TAG }'
          apiServer:
            timeoutForControlPlane: "8m0s"
            extraArgs:
              cloud-provider: external
              tls-cipher-suites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
          controllerManager:
            extraArgs:
              cloud-provider: external
              tls-cipher-suites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
          scheduler:
            extraArgs:
              tls-cipher-suites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
        files:
        initConfiguration:
          nodeRegistration:
            criSocket: /var/run/containerd/containerd.sock
            kubeletExtraArgs:
              cloud-provider: external
              tls-cipher-suites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
            name: '{{ ds.meta_data.hostname }}'
        joinConfiguration:
          nodeRegistration:
            criSocket: /var/run/containerd/containerd.sock
            kubeletExtraArgs:
              cloud-provider: external
              tls-cipher-suites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
            name: '{{ ds.meta_data.hostname }}'
        preKubeadmCommands:
        - hostname "{{ ds.meta_data.hostname }}"
        - echo "::1         ipv6-localhost ipv6-loopback" >/etc/hosts
        - echo "127.0.0.1   localhost" >>/etc/hosts
        - echo "127.0.0.1   {{ ds.meta_data.hostname }}" >>/etc/hosts
        - echo "{{ ds.meta_data.hostname }}" >/etc/hostname
        users:
        - name: capv
          sshAuthorizedKeys:
          - '${ VSPHERE_SSH_AUTHORIZED_KEY }'
          sudo: ALL=(ALL) NOPASSWD:ALL
      replicas: ${ CONTROL_PLANE_MACHINE_COUNT }
      version: '${ KUBERNETES_VERSION }'
---
apiVersion: bootstrap.cluster.x-k8s.io/v1beta1
kind: KubeadmConfigTemplate
metadata:
  name: '${ CLUSTER_NAME }-md-0'
  namespace: '${ NAMESPACE }'
spec:
  template:
    spec:
      useExperimentalRetryJoin: true
      joinConfiguration:
        nodeRegistration:
          criSocket: /var/run/containerd/containerd.sock
          kubeletExtraArgs:
            cloud-provider: external
            tls-cipher-suites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
          name: '{{ ds.meta_data.hostname }}'
      preKubeadmCommands:
      - hostname "{{ ds.meta_data.hostname }}"
      - echo "::1         ipv6-localhost ipv6-loopback" >/etc/hosts
      - echo "127.0.0.1   localhost" >>/etc/hosts
      - echo "127.0.0.1   {{ ds.meta_data.hostname }}" >>/etc/hosts
      - echo "{{ ds.meta_data.hostname }}" >/etc/hostname
      files: []
      users:
      - name: capv
        sshAuthorizedKeys:
        - '${ VSPHERE_SSH_AUTHORIZED_KEY }'
        sudo: ALL=(ALL) NOPASSWD:ALL
# ---
# apiVersion: cluster.x-k8s.io/v1beta1
# kind: MachineDeployment
# metadata:
#   labels:
#     cluster.x-k8s.io/cluster-name: '${ CLUSTER_NAME }'
#   name: '${ CLUSTER_NAME }-md-0'
#   namespace: '${ NAMESPACE }'
# spec:
#   clusterName: '${ CLUSTER_NAME }'
#   replicas: ${ WORKER_MACHINE_COUNT }
#   selector:
#     matchLabels:
#       cluster.x-k8s.io/cluster-name: '${ CLUSTER_NAME }'
#   template:
#     metadata:
#       labels:
#         cluster.x-k8s.io/cluster-name: '${ CLUSTER_NAME }'
#         node-pool: "${CLUSTER_NAME}-worker-pool"
#     spec:
#       bootstrap:
#         configRef:
#           apiVersion: bootstrap.cluster.x-k8s.io/v1beta1
#           kind: KubeadmConfigTemplate
#           name: '${ CLUSTER_NAME }-md-0'
#       clusterName: '${ CLUSTER_NAME }'
#       infrastructureRef:
#         apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
#         kind: VSphereMachineTemplate
#         name: '${ CLUSTER_NAME }-worker'
#       version: '${ KUBERNETES_VERSION }'
---
apiVersion: v1
kind: Secret
metadata:
  name: '${ CLUSTER_NAME }'
  namespace: '${ NAMESPACE }'
stringData:
  username: '${ VSPHERE_USERNAME }'
  password: '${ VSPHERE_PASSWORD }'
---
apiVersion: cluster.x-k8s.io/v1beta1
kind: ClusterClass
metadata:
  name: tkg-cluster-class-dev
  namespace: '${ NAMESPACE }'
spec:
  controlPlane:
    ref:
      apiVersion: controlplane.cluster.x-k8s.io/v1beta1
      kind: KubeadmControlPlaneTemplate
      name: '${ CLUSTER_NAME }-control-plane'
    machineInfrastructure:
      ref:
        kind: VSphereMachineTemplate
        apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
        name: '${ CLUSTER_NAME }-control-plane'
  infrastructure:
    ref:
      apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
      kind: VSphereClusterTemplate
      name: '${ CLUSTER_NAME }-infrastructure'
      namespace: '${ NAMESPACE }'
  workers:
    machineDeployments:
      - class: tkg-worker
        template:
          bootstrap:
            ref:
              kind: KubeadmConfigTemplate
              apiVersion: bootstrap.cluster.x-k8s.io/v1beta1
              name: '${ CLUSTER_NAME }-md-0'
              namespace: '${ NAMESPACE }'
          infrastructure:
            ref:
              kind: VSphereMachineTemplate
              apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
              name: '${ CLUSTER_NAME }-md-0'
              namespace: '${ NAMESPACE }'
  variables:
  - name: CONTROL_PLANE_MACHINE_COUNT
    required: true
    schema:
      openAPIV3Schema:
        type: integer
  - name: VSPHERE_CONTROL_PLANE_NUM_CPUS
    schema:
      openAPIV3Schema:
        type: integer
        default: 2
  - name: VSPHERE_CONTROL_PLANE_DISK_GIB
    schema:
      openAPIV3Schema:
        type: integer
        default: 40
  - name: VSPHERE_CONTROL_PLANE_MEM_MIB
    schema:
      openAPIV3Schema:
        type: integer
        default: 8192
  - name: VSPHERE_WORKER_NUM_CPUS
    schema:
      openAPIV3Schema:
        type: integer
        default: 2
  - name: VSPHERE_WORKER_DISK_GIB
    schema:
      openAPIV3Schema:
        type: integer
        default: 40
  - name: VSPHERE_WORKER_MEM_MIB
    schema:
      openAPIV3Schema:
        type: integer
        default: 4096
  - name: VSPHERE_CLONE_MODE
    schema:
      openAPIV3Schema:
        type: string
        default: fullClone
  - name: VSPHERE_NETWORK
    schema:
      openAPIV3Schema:
        type: string
        default: VMNetwork
  - name: VSPHERE_DATACENTER
    required: true
    schema:
      openAPIV3Schema:
        type: string
        default: ""
  - name: VSPHERE_DATASTORE
    required: true
    schema:
      openAPIV3Schema:
        type: string
        default: ""
  - name: VSPHERE_FOLDER
    required: true
    schema:
      openAPIV3Schema:
        type: string
        default: ""
  - name: VSPHERE_RESOURCE_POOL
    required: true
    schema:
      openAPIV3Schema:
        type: string
        default: ""
  - name: VSPHERE_STORAGE_POLICY_ID
    schema:
      openAPIV3Schema:
        type: string
        default: ""
  - name: VSPHERE_SERVER
    required: true
    schema:
      openAPIV3Schema:
        type: string
  - name: VSPHERE_TLS_THUMBPRINT
    schema:
      openAPIV3Schema:
        type: string
        default: ""
  - name: VSPHERE_SSH_AUTHORIZED_KEY
    schema:
      openAPIV3Schema:
        type: string
        default: ""
  - name: VSPHERE_TEMPLATE
    required: true
    schema:
      openAPIV3Schema:
        type: string
        default: ""
  - name: VSPHERE_WINDOWS_TEMPLATE
    schema:
      openAPIV3Schema:
        type: string
        default: ""
  - name: VSPHERE_CONTROL_PLANE_ENDPOINT
    required: true
    schema:
      openAPIV3Schema:
        type: string
        default: ""
  - name: VIP_NETWORK_INTERFACE
    schema:
      openAPIV3Schema:
        type: string
        default: eth0
  - name: TKG_HTTP_PROXY
    schema:
      openAPIV3Schema:
        type: string
        default: ""
  - name: TKG_HTTPS_PROXY
    schema:
      openAPIV3Schema:
        type: string
        default: ""
  - name: TKG_NO_PROXY
    schema:
      openAPIV3Schema:
        type: array
        items:
          type: string
  - name: TKG_PROXY_CA_CERT
    schema:
      openAPIV3Schema:
        type: string
  - name: TKG_CUSTOM_IMAGE_REPOSITORY
    schema:
      openAPIV3Schema:
        type: string
  # TODO this is subset of above, try to remove this      
  - name: TKG_CUSTOM_IMAGE_REPOSITORY_HOSTNAME
    schema:
      openAPIV3Schema:
        type: string
  - name: TKG_CUSTOM_IMAGE_REPOSITORY_SKIP_TLS_VERIFY
    schema:
      openAPIV3Schema:
        type: string
  - name: TKG_IP_FAMILY
    schema:
      openAPIV3Schema:
        type: string
  - name: AVI_CONTROL_PLANE_HA_PROVIDER
    schema:
      openAPIV3Schema:
        type: boolean
        default: false
  - name: CLUSTER_API_SERVER_PORT
    schema:
      openAPIV3Schema:
        type: integer
  - name: SERVICE_CIDR
    schema:
      openAPIV3Schema:
        type: string
  - name: CLUSTER_CIDR
    schema:
      openAPIV3Schema:
        type: string
  patches:
  - name: vsphereClusterTemplate
    definitions:
    - selector:
        apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
        kind: VSphereClusterTemplate
        matchResources:
          infrastructureCluster: true
      jsonPatches:
      - op: replace
        path: /spec/template/spec/controlPlaneEndpoint/host
        valueFrom:
          variable: VSPHERE_CONTROL_PLANE_ENDPOINT
      - op: replace
        path: /spec/template/spec/thumbprint
        valueFrom:
          variable: VSPHERE_TLS_THUMBPRINT
      - op: replace
        path: /spec/template/spec/server
        valueFrom:
          variable: VSPHERE_SERVER
  - name: controlPlaneMachineTemplate
    definitions:
    - selector:
        apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
        kind: VSphereMachineTemplate
        matchResources:
          controlPlane: true
      jsonPatches:
      - op: replace
        path: /spec/template/spec/numCPUs
        valueFrom:
          variable: VSPHERE_CONTROL_PLANE_NUM_CPUS
      - op: replace
        path: /spec/template/spec/diskGiB
        valueFrom:
          variable: VSPHERE_CONTROL_PLANE_DISK_GIB
      - op: replace
        path: /spec/template/spec/memoryMiB
        valueFrom:
          variable: VSPHERE_CONTROL_PLANE_MEM_MIB
      - op: replace
        path: /spec/template/spec/cloneMode
        valueFrom:
          variable: VSPHERE_CLONE_MODE
      - op: replace
        path: /spec/template/spec/network
        valueFrom:
          variable: VSPHERE_NETWORK
      - op: replace
        path: /spec/template/spec/template
        valueFrom:
          variable: VSPHERE_TEMPLATE
      - op: replace
        path: /spec/template/spec/datacenter
        valueFrom:
          variable: VSPHERE_DATACENTER
      - op: replace
        path: /spec/template/spec/datastore
        valueFrom:
          variable: VSPHERE_DATASTORE
      - op: replace
        path: /spec/template/spec/folder
        valueFrom:
          variable: VSPHERE_FOLDER
      - op: replace
        path: /spec/template/spec/resourcePool
        valueFrom:
          variable: VSPHERE_RESOURCE_POOL
      - op: replace
        path: /spec/template/spec/storagePolicyName
        valueFrom:
          variable: VSPHERE_STORAGE_POLICY_ID
      - op: replace
        path: /spec/template/spec/server
        valueFrom:
          variable: VSPHERE_SERVER
  - name: workerMachineTemplate
    definitions:
    - selector:
        apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
        kind: VSphereMachineTemplate
        matchResources:
          machineDeploymentClass:
            names:
            - tkg-worker
      jsonPatches:
      - op: replace
        path: /spec/template/spec/numCPUs
        valueFrom:
          variable: VSPHERE_WORKER_NUM_CPUS
      - op: replace
        path: /spec/template/spec/diskGiB
        valueFrom:
          variable: VSPHERE_WORKER_DISK_GIB
      - op: replace
        path: /spec/template/spec/memoryMiB
        valueFrom:
          variable: VSPHERE_WORKER_MEM_MIB
      - op: replace
        path: /spec/template/spec/cloneMode
        valueFrom:
          variable: VSPHERE_CLONE_MODE
      - op: replace
        path: /spec/template/spec/network
        valueFrom:
          variable: VSPHERE_NETWORK
      - op: replace
        path: /spec/template/spec/template
        valueFrom:
          variable: VSPHERE_TEMPLATE
      - op: replace
        path: /spec/template/spec/datacenter
        valueFrom:
          variable: VSPHERE_DATACENTER
      - op: replace
        path: /spec/template/spec/datastore
        valueFrom:
          variable: VSPHERE_DATASTORE
      - op: replace
        path: /spec/template/spec/folder
        valueFrom:
          variable: VSPHERE_FOLDER
      - op: replace
        path: /spec/template/spec/resourcePool
        valueFrom:
          variable: VSPHERE_RESOURCE_POOL
      - op: replace
        path: /spec/template/spec/storagePolicyName
        valueFrom:
          variable: VSPHERE_STORAGE_POLICY_ID
      - op: replace
        path: /spec/template/spec/server
        valueFrom:
          variable: VSPHERE_SERVER
  - name: kubeadmControlPlaneTemplate
    definitions:
    - selector:
        apiVersion: controlplane.cluster.x-k8s.io/v1beta1
        kind: KubeadmControlPlaneTemplate
        matchResources:
          controlPlane: true
      jsonPatches:
      - op: replace
        path: /spec/template/spec/kubeadmConfigSpec/users
        valueFrom:
          template: |
            - name: capv
              sshAuthorizedKeys:
              - '{{.VSPHERE_SSH_AUTHORIZED_KEY}}'
              sudo: ALL=(ALL) NOPASSWD:ALL
      - op: replace
        path: /spec/template/spec/replicas
        valueFrom:
          variable: CONTROL_PLANE_MACHINE_COUNT
  - name: KubeadmConfigTemplate
    definitions:
    - selector:
        apiVersion: bootstrap.cluster.x-k8s.io/v1beta1
        kind: KubeadmConfigTemplate
        matchResources:
          machineDeploymentClass:
            names:
            - tkg-worker
      jsonPatches:
      - op: replace
        path: /spec/template/spec/users
        valueFrom:
          template: |
            - name: capv
              sshAuthorizedKeys:
              - '{{.VSPHERE_SSH_AUTHORIZED_KEY}}'
              sudo: ALL=(ALL) NOPASSWD:ALL
  - name: kubeVIPPod
    enabledIf: '{{not .AVI_CONTROL_PLANE_HA_PROVIDER}}'
    definitions:
    - selector:
        apiVersion: controlplane.cluster.x-k8s.io/v1beta1
        kind: KubeadmControlPlaneTemplate
        matchResources:
          controlPlane: true
      jsonPatches:
      - op: add
        path: /spec/template/spec/kubeadmConfigSpec/files/-
        valueFrom:
          # TODO fix the image path
          template: |
            owner: root:root
            path: /etc/kubernetes/manifests/kube-vip.yaml
            content: |
              ---
              apiVersion: v1
              kind: Pod
              metadata:
                creationTimestamp: null
                name: kube-vip
                namespace: kube-system
              spec:
                containers:
                - args:
                  - start
                  env:
                  - name: vip_arp
                    value: "true"
                  - name: vip_leaderelection
                    value: "true"
                  - name: address
                    value: {{.VSPHERE_CONTROL_PLANE_ENDPOINT}}
                  {{- if and (not .AVI_CONTROL_PLANE_HA_PROVIDER) .CLUSTER_API_SERVER_PORT }}
                  - name: port
                    value: {{.CLUSTER_API_SERVER_PORT}}
                  {{- end }}
                  - name: vip_interface
                    value: {{.VIP_NETWORK_INTERFACE}}
                  - name: vip_leaseduration
                    value: "30"
                  - name: vip_renewdeadline
                    value: "20"
                  - name: vip_retryperiod
                    value: "4"
                  image: #@ "{}/{}:{}".format(get_image_repo_for_component(bomData.components["kube-vip"][0].images.kubeVipImage), bomData.components["kube-vip"][0].images.kubeVipImage.imagePath, bomData.components["kube-vip"][0].images.kubeVipImage.tag)
                  imagePullPolicy: IfNotPresent
                  name: kube-vip
                  resources: {}
                  securityContext:
                    capabilities:
                      add:
                      - NET_ADMIN
                      - SYS_TIME
                  volumeMounts:
                  - mountPath: /etc/kubernetes/admin.conf
                    name: kubeconfig
                hostNetwork: true
                volumes:
                - hostPath:
                    path: /etc/kubernetes/admin.conf
                    type: FileOrCreate
                  name: kubeconfig
              status: {}
  - name: networkConfiguration
    definitions:
    - selector:
        apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
        kind: VSphereMachineTemplate
        matchResources:
          controlPlane: true
      jsonPatches:
      - op: replace
        path: /spec/template/spec/network
        valueFrom:
          template: |
            devices:
            - networkName: {{.VSPHERE_NETWORK}}
              nameservers: {{.CONTROL_PLANE_NODE_NAMESERVERS}}
              dhcp4: {{or (eq "ipv4" .TKG_IP_FAMILY) (or (eq "ipv4,ipv6" .TKG_IP_FAMILY) (eq "ipv6,ipv4" .TKG_IP_FAMILY))}}
              dhcp6: {{or (eq "ipv6" .TKG_IP_FAMILY) (or (eq "ipv4,ipv6" .TKG_IP_FAMILY) (eq "ipv6,ipv4" .TKG_IP_FAMILY))}}
    - selector:
        apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
        kind: VSphereMachineTemplate
        matchResources:
          machineDeploymentClass:
            names:
            - tkg-worker
      jsonPatches:
      - op: add
        path: /spec/template/spec/network
        valueFrom:
          template: |
            devices:
            - networkName: {{.VSPHERE_NETWORK}}
              nameservers: {{.CONTROL_PLANE_NODE_NAMESERVERS}}
              dhcp4: {{or (eq "ipv4" .TKG_IP_FAMILY) (or (eq "ipv4,ipv6" .TKG_IP_FAMILY) (eq "ipv6,ipv4" .TKG_IP_FAMILY))}}
              dhcp6: {{or (eq "ipv6" .TKG_IP_FAMILY) (or (eq "ipv4,ipv6" .TKG_IP_FAMILY) (eq "ipv6,ipv4" .TKG_IP_FAMILY))}}
  - name: controlPlaneEndpointConfiguration
    enabledIf: '{{and (not .AVI_CONTROL_PLANE_HA_PROVIDER) (ne nil .CLUSTER_API_SERVER_PORT)}}'
    definitions:
    - selector:
        apiVersion: controlplane.cluster.x-k8s.io/v1beta1
        kind: KubeadmControlPlaneTemplate
        matchResources:
          controlPlane: true
      jsonPatches:
      - op: replace
        path: /spec/template/spec/kubeadmConfigSpec/initConfiguration/localAPIEndpoint/
        valueFrom:
          template: |
            {{if or (eq "ipv6" .TKG_IP_FAMILY) (eq "ipv6,ipv4" .TKG_IP_FAMILY) }}advertiseAddress: '::/0'
            {{- else }}
            advertiseAddress: '0.0.0.0'
            {{- end }}
            bindPort: {{.CLUSTER_API_SERVER_PORT}}
      - op: replace
        path: /spec/template/spec/joinConfiguration/controlPlane/localAPIEndpoint
        valueFrom:
          template: |
            {{if or (eq "ipv6" .TKG_IP_FAMILY) (eq "ipv6,ipv4" .TKG_IP_FAMILY) }}advertiseAddress: '::/0'
            {{- else }}
            advertiseAddress: '0.0.0.0'
            {{- end }}
            bindPort: {{.CLUSTER_API_SERVER_PORT}}
  - name: bindAddressConfiguration
    enabledIf: '{{eq "ipv6,ipv4" .TKG_IP_FAMILY}}'
    definitions:
    - selector:
        apiVersion: controlplane.cluster.x-k8s.io/v1beta1
        kind: KubeadmControlPlaneTemplate
        matchResources:
          controlPlane: true
      jsonPatches:
      - op: add
        path: /spec/template/spec/kubeadmConfigSpec/initConfiguration/nodeRegistration/kubeletExtraArgs
        value:
          node-ip: "::"
      - op: add
        path: /spec/template/spec/kubeadmConfigSpec/joinConfiguration/nodeRegistration/kubeletExtraArgs
        value:
          node-ip: "::"
      - op: add
        path: /spec/template/spec/kubeadmConfigSpec/clusterConfiguration/apiServer/extraArgs
        valueFrom:
          template: |
            advertise-address: {{.VSPHERE_CONTROL_PLANE_ENDPOINT}}
            bind-address: "::"
      - op: add
        path: /spec/template/spec/kubeadmConfigSpec/clusterConfiguration/controllerManager/extraArgs
        value:
          bind-address: "::"
      - op: add
        path: /spec/template/spec/kubeadmConfigSpec/clusterConfiguratio/scheduler/extraArgs
        value:
          bind-address: "::"
    - selector:
        apiVersion: bootstrap.cluster.x-k8s.io/v1beta1
        kind: KubeadmConfigTemplate
        matchResources:
          machineDeploymentClass:
            names:
            - tkg-worker
      jsonPatches:
      - op: add
        path: /spec/template/spec/joinConfiguration/nodeRegistration/kubeletExtraArgs
        value:
          node-ip: "::"
  - name: ipv6Hack
    enabledIf: '{{eq "ipv6" .TKG_IP_FAMILY}}'
    definitions:
    - selector:
        apiVersion: controlplane.cluster.x-k8s.io/v1beta1
        kind: KubeadmControlPlaneTemplate
        matchResources:
          controlPlane: true
      jsonPatches:
      - op: add
        path: /spec/template/spec/kubeadmConfigSpec/postKubeadmCommands/-
        value: sed -i '/listen-client-urls/ s/$/,https:\/\/127.0.0.1:2379/' /etc/kubernetes/manifests/etcd.yaml
  - name: httpProxy
    enabledIf: '{{ne "" .TKG_HTTP_PROXY}}'
    definitions:
    - selector:
        apiVersion: controlplane.cluster.x-k8s.io/v1beta1
        kind: KubeadmControlPlaneTemplate
        matchResources:
          controlPlane: true
      jsonPatches:
      - op: add
        path: /spec/template/spec/kubeadmConfigSpec/files/-
        valueFrom:
          template: |
            content: |
              [Service]
              Environment="HTTP_PROXY={{.TKG_HTTP_PROXY}}"
              Environment="HTTPS_PROXY={{.TKG_HTTPS_PROXY}}"
              Environment="NO_PROXY={{- range .TKG_NO_PROXY}}{{.}},{{- end}}{{.SERVICE_CIDR}},{{.CLUSTER_CIDR}},localhost,127.0.0.1
            {{- if or (eq "ipv6" .TKG_IP_FAMILY) (or (eq "ipv4,ipv6" .TKG_IP_FAMILY) (eq "ipv6,ipv4" .TKG__IP_FAMILY))}},::1{{end}},.scv,.svc.cluster.local"
            owner: root:root
            path: /etc/systemd/system/containerd.service.d/http-proxy.conf
            permissions: "0640"
      - op: add
        path: /spec/template/spec/kubeadmConfigSpec/files/-
        valueFrom:
          template: |
            content: |
              [Service]
              Environment="HTTP_PROXY={{.TKG_HTTP_PROXY}}"
              Environment="HTTPS_PROXY={{.TKG_HTTPS_PROXY}}"
              Environment="NO_PROXY={{- range .TKG_NO_PROXY}}{{.}},{{- end}}{{.SERVICE_CIDR}},{{.CLUSTER_CIDR}},localhost,127.0.0.1
            {{- if or (eq "ipv6" .TKG_IP_FAMILY) (or (eq "ipv4,ipv6" .TKG_IP_FAMILY) (eq "ipv6,ipv4" .TKG__IP_FAMILY))}},::1{{end}},.scv,.svc.cluster.local"
            owner: root:root
            path: /usr/lib/systemd/system/kubelet.service.d/http-proxy.conf
            permissions: "0640"
      - op: add
        path: /spec/template/spec/kubeadmConfigSpec/preKubeadmCommands/-
        value: systemctl daemon-reload
      - op: add
        path: /spec/template/spec/kubeadmConfigSpec/preKubeadmCommands/-
        value: systemctl stop containerd
      - op: add
        path: /spec/template/spec/kubeadmConfigSpec/preKubeadmCommands/-
        value: systemctl start containerd
      - op: add
        path: /spec/template/spec/kubeadmConfigSpec/preKubeadmCommands/-
        valueFrom:
          template: |
            export HTTP_PROXY={{.TKG_HTTP_PROXY}}
      - op: add
        path: /spec/template/spec/kubeadmConfigSpec/preKubeadmCommands/-
        valueFrom:
          template: |
            export HTTPS_PROXY={{.TKG_HTTPS_PROXY}}
      - op: add
        path: /spec/template/spec/kubeadmConfigSpec/preKubeadmCommands/-
        valueFrom:
          template: |
            export NO_PROXY={{- range .TKG_NO_PROXY}}{{.}},{{- end}}{{.SERVICE_CIDR}},{{.CLUSTER_CIDR}},localhost,127.0.0.1
            {{- if or (eq "ipv6" .TKG_IP_FAMILY) (or (eq "ipv4,ipv6" .TKG_IP_FAMILY) (eq "ipv6,ipv4" .TKG__IP_FAMILY))}},::1{{end}},.scv,.svc.cluster.local
    - selector:
        apiVersion: bootstrap.cluster.x-k8s.io/v1beta1
        kind: KubeadmConfigTemplate
        matchResources:
          machineDeploymentClass:
            names:
            - tkg-worker
      jsonPatches:
      - op: add
        path: /spec/template/spec/files/-
        valueFrom:
          template: |
            content: |
              [Service]
              Environment="HTTP_PROXY={{.TKG_HTTP_PROXY}}"
              Environment="HTTPS_PROXY={{.TKG_HTTPS_PROXY}}"
              Environment="NO_PROXY={{- range .TKG_NO_PROXY}}{{.}},{{- end}}{{.SERVICE_CIDR}},{{.CLUSTER_CIDR}},localhost,127.0.0.1
            {{- if or (eq "ipv6" .TKG_IP_FAMILY) (or (eq "ipv4,ipv6" .TKG_IP_FAMILY) (eq "ipv6,ipv4" .TKG__IP_FAMILY))}},::1{{end}},.scv,.svc.cluster.local"
            owner: root:root
            path: /etc/systemd/system/containerd.service.d/http-proxy.conf
            permissions: "0640"
      - op: add
        path: /spec/template/spec/files/-
        valueFrom:
          template: |
            content: |
              [Service]
              Environment="HTTP_PROXY={{.TKG_HTTP_PROXY}}"
              Environment="HTTPS_PROXY={{.TKG_HTTPS_PROXY}}"
              Environment="NO_PROXY={{- range .TKG_NO_PROXY}}{{.}},{{- end}}{{.SERVICE_CIDR}},{{.CLUSTER_CIDR}},localhost,127.0.0.1
            {{- if or (eq "ipv6" .TKG_IP_FAMILY) (or (eq "ipv4,ipv6" .TKG_IP_FAMILY) (eq "ipv6,ipv4" .TKG__IP_FAMILY))}},::1{{end}},.scv,.svc.cluster.local"
            owner: root:root
            path: /usr/lib/systemd/system/kubelet.service.d/http-proxy.conf
            permissions: "0640"
      - op: add
        path: /spec/template/spec/preKubeadmCommands/-
        value: systemctl daemon-reload
      - op: add
        path: /spec/template/spec/preKubeadmCommands/-
        value: systemctl restart containerd
      - op: add
        path: /spec/template/spec/preKubeadmCommands/-
        valueFrom:
          template: |
            export HTTP_PROXY={{.TKG_HTTP_PROXY}}
      - op: add
        path: /spec/template/spec/preKubeadmCommands/-
        valueFrom:
          template: |
            export HTTPS_PROXY={{.TKG_HTTPS_PROXY}}
      - op: add
        path: /spec/template/spec/preKubeadmCommands/-
        valueFrom:
          template: |
            export NO_PROXY={{- range .TKG_NO_PROXY}}{{.}},{{- end}}{{.SERVICE_CIDR}},{{.CLUSTER_CIDR}},localhost,127.0.0.1
            {{- if or (eq "ipv6" .TKG_IP_FAMILY) (or (eq "ipv4,ipv6" .TKG_IP_FAMILY) (eq "ipv6,ipv4" .TKG__IP_FAMILY))}},::1{{end}},.scv,.svc.cluster.local
  - name: registryCACert
    enabledif: '{{and (ne "" (or .TKG_PROXY_CA_CERT .TKG_CUSTOM_IMAGE_REPOSITORY_CA_CERTIFICATE)) (and .TKG_CUSTOM_IMAGE_REPOSITORY_SKIP_TLS_VERIFY (ne "" .TKG_CUSTOM_IMAGE_REPOSITORY)) }}'
    definitions:
    - selector:
        apiVersion: controlplane.cluster.x-k8s.io/v1beta1
        kind: KubeadmControlPlaneTemplate
        matchResources:
          controlPlane: true
      jsonPatches:
      - op: add
        path: /spec/template/spec/kubeadmConfigSpec/preKubeadmCommands/-
        valueFrom:
          template: |
            "echo '[plugins.\"io.containerd.grpc.v1.cri\".registry.configs.\"{{.TKG_CUSTOM_IMAGE_REPOSITORY_HOSTNAME}}\".tls]' >> /etc/containerd/config.toml"
      - op: add
        path: /spec/template/spec/kubeadmConfigSpec/preKubeadmCommands/-
        valueFrom:
          template: |
            "echo '  ca_file = \"/etc/containerd/{{.TKG_CUSTOM_IMAGE_REPOSITORY_HOSTNAME}}.crt\"' >> /etc/containerd/config.toml"
      - op: add
        path: /spec/template/spec/kubeadmConfigSpec/preKubeadmCommands/-
        value: systemctl restart containerd
      - op: add
        path: /spec/template/spec/kubeadmConfigSpec/files/-
        valueFrom:
          template: |
            path: "/etc/containerd/{{.TKG_CUSTOM_IMAGE_REPOSITORY_HOSTNAME}}.crt"
            content: {{or .TKG_PROXY_CA_CERT .TKG_CUSTOM_IMAGE_REPOSITORY_CA_CERTIFICATE}}
            encoding: "base64"
            permissions: "0444"
    - selector:
        apiVersion: bootstrap.cluster.x-k8s.io/v1beta1
        kind: KubeadmConfigTemplate
        matchResources:
          machineDeploymentClass:
            names:
            - tkg-worker
      jsonPatches:
      - op: add
        path: /spec/template/spec/preKubeadmCommands/-
        valueFrom:
          template: |
            "echo '[plugins.\"io.containerd.grpc.v1.cri\".registry.configs.\"{{.TKG_CUSTOM_IMAGE_REPOSITORY_HOSTNAME}}\".tls]' >> /etc/containerd/config.toml"
      - op: add
        path: /spec/template/spec/preKubeadmCommands/-
        valueFrom:
          template: |
            "echo '  ca_file = \"/etc/containerd/{{.TKG_CUSTOM_IMAGE_REPOSITORY_HOSTNAME}}.crt\"' >> /etc/containerd/config.toml"
      - op: add
        path: /spec/template/spec/preKubeadmCommands/-
        value: systemctl restart containerd
      - op: add
        path: /spec/template/spec/files/-
        valueFrom:
          template: |
            path: "/etc/containerd/{{.TKG_CUSTOM_IMAGE_REPOSITORY_HOSTNAME}}.crt"
            content: {{or .TKG_PROXY_CA_CERT .TKG_CUSTOM_IMAGE_REPOSITORY_CA_CERTIFICATE}}
            encoding: "base64"
            permissions: "0444"
  - name: registrySkipTLSVerify
    enabledIf: '{{ne "" .TKG_CUSTOM_IMAGE_REPOSITORY}}'
    definitions:
    - selector:
        apiVersion: controlplane.cluster.x-k8s.io/v1beta1
        kind: KubeadmControlPlaneTemplate
        matchResources:
          controlPlane: true
      jsonPatches:
      - op: add
        path: /spec/template/spec/kubeadmConfigSpec/preKubeadmCommands/-
        valueFrom:
          template: |
            sed -i 's|\".*/pause|\{{.TKG_IMAGE_REPO}}/pause|' /etc/containerd/config.toml
      - op: add
        path: /spec/template/spec/kubeadmConfigSpec/preKubeadmCommands/-
        valueFrom:
          # TODO fix value of TKG_CUSTOM_IMAGE_REPOSITORY_HOSTNAME
          template: |
            {{if .TKG_CUSTOM_IMAGE_REPOSITORY_SKIP_TLS_VERIFY}}
            echo '[plugins.\"io.containerd.grpc.v1.cri\".registry.configs.\"{{.TKG_CUSTOM_IMAGE_REPOSITORY_HOSTNAME}}\".tls]' >> /etc/containerd/config.toml && echo '  insecure_skip_verify = true' >> /etc/containerd/config.toml
            {{- end}}            
      - op: add
        path: /spec/template/spec/kubeadmConfigSpec/preKubeadmCommands/-
        value: systemctl restart containerd
    - selector:
        apiVersion: bootstrap.cluster.x-k8s.io/v1beta1
        kind: KubeadmConfigTemplate
        matchResources:
          machineDeploymentClass:
            names:
            - tkg-worker
      jsonPatches:
      - op: add
        path: /spec/template/spec/preKubeadmCommands/-
        valueFrom:
          template: |
            sed -i 's|\".*/pause|\{{.TKG_IMAGE_REPO}}/pause|' /etc/containerd/config.toml
      - op: add
        path: /spec/template/spec/preKubeadmCommands/-
        valueFrom:
          # TODO fix value of TKG_CUSTOM_IMAGE_REPOSITORY_HOSTNAME
          template: |
            {{if .TKG_CUSTOM_IMAGE_REPOSITORY_SKIP_TLS_VERIFY}}
            echo '[plugins.\"io.containerd.grpc.v1.cri\".registry.configs.\"{{.TKG_CUSTOM_IMAGE_REPOSITORY_HOSTNAME}}\".tls]' >> /etc/containerd/config.toml && echo '  insecure_skip_verify = true' >> /etc/containerd/config.toml
            {{- end}}
      - op: add
        path: /spec/template/spec/preKubeadmCommands/-
        value: systemctl restart containerd
