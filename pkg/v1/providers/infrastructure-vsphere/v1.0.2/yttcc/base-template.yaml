apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: VSphereClusterTemplate
metadata:
  name: '${ CLUSTER_NAME }-infrastructure'
  namespace: '${ NAMESPACE }'
spec:
  template:
    spec:
      controlPlaneEndpoint:
        host: '${VSPHERE_CONTROL_PLANE_ENDPOINT}'
        port: 6443
      identityRef:
        kind: Secret
        name: '${ CLUSTER_NAME }'
      server: '${ VSPHERE_SERVER }'
      thumbprint: '${ VSPHERE_TLS_THUMBPRINT }'
---
apiVersion: cluster.x-k8s.io/v1beta1
kind: Cluster
metadata:
  name: ${CLUSTER_NAME}
  labels:
    tkg.tanzu.vmware.com/cluster-name: '${ CLUSTER_NAME }'
spec:
  clusterNetwork:
    pods:
      cidrBlocks: ["${CLUSTER_CIDR}"]
    services:
      cidrBlocks: ["${SERVICE_CIDR}"]
  topology:
    class: tkg-cluster-class-dev
    version: v1.21.2
    controlPlane:
      replicas: ${CONTROL_PLANE_MACHINE_COUNT}
    workers:
      machineDeployments:
      - class: tkg-worker
        name: tkg-worker-pool
        replicas: ${WORKER_MACHINE_COUNT}
    variables:
    - name: VSPHERE_CONTROL_PLANE_ENDPOINT
      value: "${VSPHERE_CONTROL_PLANE_ENDPOINT}"
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: VSphereMachineTemplate
metadata:
  name: '${ CLUSTER_NAME }-control-plane'
  namespace: '${ NAMESPACE }'
spec:
  template:
    spec:
      cloneMode: '${ VSPHERE_CLONE_MODE }'
      datacenter: '${ VSPHERE_DATACENTER }'
      datastore: '${ VSPHERE_DATASTORE }'
      storagePolicyName: '${ VSPHERE_STORAGE_POLICY_ID }'
      diskGiB: ${VSPHERE_CONTROL_PLANE_DISK_GIB}
      folder: '${ VSPHERE_FOLDER }'
      memoryMiB: ${VSPHERE_CONTROL_PLANE_MEM_MIB}
      network:
        devices:
        - dhcp4: true
          networkName: '${ VSPHERE_NETWORK }'
      numCPUs: ${ VSPHERE_CONTROL_PLANE_NUM_CPUS }
      resourcePool: '${ VSPHERE_RESOURCE_POOL }'
      server: '${ VSPHERE_SERVER }'
      template: '${ VSPHERE_TEMPLATE }'
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: VSphereMachineTemplate
metadata:
  name: '${ CLUSTER_NAME }-worker'
  namespace: '${ NAMESPACE }'
spec:
  template:
    spec:
      cloneMode: '${ VSPHERE_CLONE_MODE }'
      datacenter: '${ VSPHERE_DATACENTER }'
      datastore: '${ VSPHERE_DATASTORE }'
      storagePolicyName: '${ VSPHERE_STORAGE_POLICY_ID }'
      diskGiB: ${VSPHERE_WORKER_DISK_GIB}
      folder: '${ VSPHERE_FOLDER }'
      memoryMiB: ${VSPHERE_WORKER_MEM_MIB}
      network:
        devices:
        - dhcp4: true
          networkName: '${ VSPHERE_NETWORK }'
      numCPUs: ${ VSPHERE_WORKER_NUM_CPUS }
      resourcePool: '${ VSPHERE_RESOURCE_POOL }'
      server: '${ VSPHERE_SERVER }'
      template: '${ VSPHERE_TEMPLATE }'
---
apiVersion: controlplane.cluster.x-k8s.io/v1beta1
kind: KubeadmControlPlaneTemplate
metadata:
  name: '${ CLUSTER_NAME }-control-plane'
  namespace: '${ NAMESPACE }'
spec:
  template:
    spec:
      machineTemplate:
        infrastructureRef:
          apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
          kind: VSphereMachineTemplate
          name: '${ CLUSTER_NAME }-control-plane'
      kubeadmConfigSpec:
        useExperimentalRetryJoin: true
        clusterConfiguration:
          imageRepository: '${ _TKG_K8S_IMAGE_REPOSITORY }'
          etcd:
            local:
              dataDir: /var/lib/etcd
              imageRepository: '${ _TKG_ETCD_IMAGE_REPOSITORY }'
              imageTag: '${ _TKG_ETCD_IMAGE_TAG }'
              extraArgs:
                cipher-suites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
          dns:
            imageRepository: '${ _TKG_COREDNS_IMAGE_REPOSITORY }'
            imageTag: '${ _TKG_COREDNS_IMAGE_TAG }'
          apiServer:
            timeoutForControlPlane: "8m0s"
            extraArgs:
              cloud-provider: external
              tls-cipher-suites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
          controllerManager:
            extraArgs:
              cloud-provider: external
              tls-cipher-suites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
          scheduler:
            extraArgs:
              tls-cipher-suites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
        files:
        - content: |
            apiVersion: v1
            kind: Pod
            metadata:
              creationTimestamp: null
              name: kube-vip
              namespace: kube-system
            spec:
              containers:
              - args:
                - start
                env:
                - name: vip_arp
                  value: "true"
                - name: vip_leaderelection
                  value: "true"
                - name: address
                  value: '${ VSPHERE_CONTROL_PLANE_ENDPOINT }'
                - name: vip_interface
                  value: '${ VIP_NETWORK_INTERFACE }'
                - name: vip_leaseduration
                  value: "30"
                - name: vip_renewdeadline
                  value: "20"
                - name: vip_retryperiod
                  value: "4"
                image: '${ _TKG_KUBE_VIP_IMAGE }'
                imagePullPolicy: IfNotPresent
                name: kube-vip
                resources: {}
                securityContext:
                  capabilities:
                    add:
                    - NET_ADMIN
                    - SYS_TIME
                volumeMounts:
                - mountPath: /etc/kubernetes/admin.conf
                  name: kubeconfig
              hostNetwork: true
              volumes:
              - hostPath:
                  path: /etc/kubernetes/admin.conf
                  type: FileOrCreate
                name: kubeconfig
            status: {}
          owner: root:root
          path: /etc/kubernetes/manifests/kube-vip.yaml
        initConfiguration:
          nodeRegistration:
            criSocket: /var/run/containerd/containerd.sock
            kubeletExtraArgs:
              cloud-provider: external
              tls-cipher-suites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
            name: '{{ ds.meta_data.hostname }}'
        joinConfiguration:
          nodeRegistration:
            criSocket: /var/run/containerd/containerd.sock
            kubeletExtraArgs:
              cloud-provider: external
              tls-cipher-suites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
            name: '{{ ds.meta_data.hostname }}'
        preKubeadmCommands:
        - hostname "{{ ds.meta_data.hostname }}"
        - echo "::1         ipv6-localhost ipv6-loopback" >/etc/hosts
        - echo "127.0.0.1   localhost" >>/etc/hosts
        - echo "127.0.0.1   {{ ds.meta_data.hostname }}" >>/etc/hosts
        - echo "{{ ds.meta_data.hostname }}" >/etc/hostname
        users:
        - name: capv
          sshAuthorizedKeys:
          - '${ VSPHERE_SSH_AUTHORIZED_KEY }'
          sudo: ALL=(ALL) NOPASSWD:ALL
      replicas: ${ CONTROL_PLANE_MACHINE_COUNT }
      version: '${ KUBERNETES_VERSION }'
---
apiVersion: bootstrap.cluster.x-k8s.io/v1beta1
kind: KubeadmConfigTemplate
metadata:
  name: '${ CLUSTER_NAME }-md-0'
  namespace: '${ NAMESPACE }'
spec:
  template:
    spec:
      useExperimentalRetryJoin: true
      joinConfiguration:
        nodeRegistration:
          criSocket: /var/run/containerd/containerd.sock
          kubeletExtraArgs:
            cloud-provider: external
            tls-cipher-suites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
          name: '{{ ds.meta_data.hostname }}'
      preKubeadmCommands:
      - hostname "{{ ds.meta_data.hostname }}"
      - echo "::1         ipv6-localhost ipv6-loopback" >/etc/hosts
      - echo "127.0.0.1   localhost" >>/etc/hosts
      - echo "127.0.0.1   {{ ds.meta_data.hostname }}" >>/etc/hosts
      - echo "{{ ds.meta_data.hostname }}" >/etc/hostname
      files: []
      users:
      - name: capv
        sshAuthorizedKeys:
        - '${ VSPHERE_SSH_AUTHORIZED_KEY }'
        sudo: ALL=(ALL) NOPASSWD:ALL
# ---
# apiVersion: cluster.x-k8s.io/v1beta1
# kind: MachineDeployment
# metadata:
#   labels:
#     cluster.x-k8s.io/cluster-name: '${ CLUSTER_NAME }'
#   name: '${ CLUSTER_NAME }-md-0'
#   namespace: '${ NAMESPACE }'
# spec:
#   clusterName: '${ CLUSTER_NAME }'
#   replicas: ${ WORKER_MACHINE_COUNT }
#   selector:
#     matchLabels:
#       cluster.x-k8s.io/cluster-name: '${ CLUSTER_NAME }'
#   template:
#     metadata:
#       labels:
#         cluster.x-k8s.io/cluster-name: '${ CLUSTER_NAME }'
#         node-pool: "${CLUSTER_NAME}-worker-pool"
#     spec:
#       bootstrap:
#         configRef:
#           apiVersion: bootstrap.cluster.x-k8s.io/v1beta1
#           kind: KubeadmConfigTemplate
#           name: '${ CLUSTER_NAME }-md-0'
#       clusterName: '${ CLUSTER_NAME }'
#       infrastructureRef:
#         apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
#         kind: VSphereMachineTemplate
#         name: '${ CLUSTER_NAME }-worker'
#       version: '${ KUBERNETES_VERSION }'
---
apiVersion: v1
kind: Secret
metadata:
  name: '${ CLUSTER_NAME }'
  namespace: '${ NAMESPACE }'
stringData:
  username: '${ VSPHERE_USERNAME }'
  password: '${ VSPHERE_PASSWORD }'
---
apiVersion: cluster.x-k8s.io/v1beta1
kind: ClusterClass
metadata:
  name: tkg-cluster-class-dev
  namespace: '${ NAMESPACE }'
spec:
  controlPlane:
    ref:
      apiVersion: controlplane.cluster.x-k8s.io/v1beta1
      kind: KubeadmControlPlaneTemplate
      name: '${ CLUSTER_NAME }-control-plane'
    machineInfrastructure:
      ref:
        kind: VSphereMachineTemplate
        apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
        name: '${ CLUSTER_NAME }-control-plane'
  infrastructure:
    ref:
      apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
      kind: VSphereClusterTemplate
      name: '${ CLUSTER_NAME }-infrastructure'
      namespace: '${ NAMESPACE }'
  workers:
    machineDeployments:
      - class: tkg-worker
        template:
          bootstrap:
            ref:
              kind: KubeadmConfigTemplate
              apiVersion: bootstrap.cluster.x-k8s.io/v1beta1
              name: '${ CLUSTER_NAME }-md-0'
              namespace: '${ NAMESPACE }'
          infrastructure:
            ref:
              kind: VSphereMachineTemplate
              apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
              name: '${ CLUSTER_NAME }-md-0'
              namespace: '${ NAMESPACE }'
  variables:
  - name: CONTROL_PLANE_MACHINE_COUNT
    required: true
    schema:
      openAPIV3Schema:
        type: integer
  - name: VSPHERE_CONTROL_PLANE_NUM_CPUS
    schema:
      openAPIV3Schema:
        type: integer
        default: 2
  - name: VSPHERE_CONTROL_PLANE_DISK_GIB
    schema:
      openAPIV3Schema:
        type: integer
        default: 40
  - name: VSPHERE_CONTROL_PLANE_MEM_MIB
    schema:
      openAPIV3Schema:
        type: integer
        default: 8192
  - name: VSPHERE_WORKER_NUM_CPUS
    schema:
      openAPIV3Schema:
        type: integer
        default: 2
  - name: VSPHERE_WORKER_DISK_GIB
    schema:
      openAPIV3Schema:
        type: integer
        default: 40
  - name: VSPHERE_WORKER_MEM_MIB
    schema:
      openAPIV3Schema:
        type: integer
        default: 4096
  - name: VSPHERE_CLONE_MODE
    schema:
      openAPIV3Schema:
        type: string
        default: fullClone
  - name: VSPHERE_NETWORK
    schema:
      openAPIV3Schema:
        type: string
        default: VMNetwork
  - name: VSPHERE_DATACENTER
    required: true
    schema:
      openAPIV3Schema:
        type: string
        default: ""
  - name: VSPHERE_DATASTORE
    required: true
    schema:
      openAPIV3Schema:
        type: string
        default: ""
  - name: VSPHERE_FOLDER
    required: true
    schema:
      openAPIV3Schema:
        type: string
        default: ""
  - name: VSPHERE_RESOURCE_POOL
    required: true
    schema:
      openAPIV3Schema:
        type: string
        default: ""
  - name: VSPHERE_STORAGE_POLICY_ID
    schema:
      openAPIV3Schema:
        type: string
        default: ""
  - name: VSPHERE_SERVER
    required: true
    schema:
      openAPIV3Schema:
        type: string
  - name: VSPHERE_TLS_THUMBPRINT
    schema:
      openAPIV3Schema:
        type: string
        default: ""
  - name: VSPHERE_SSH_AUTHORIZED_KEY
    schema:
      openAPIV3Schema:
        type: string
        default: ""
  - name: VSPHERE_TEMPLATE
    required: true
    schema:
      openAPIV3Schema:
        type: string
        default: ""
  - name: VSPHERE_WINDOWS_TEMPLATE
    schema:
      openAPIV3Schema:
        type: string
        default: ""
  - name: VSPHERE_CONTROL_PLANE_ENDPOINT
    required: true
    schema:
      openAPIV3Schema:
        type: string
        default: ""
  - name: TKG_HTTP_PROXY
    schema:
      openAPIV3Schema:
        type: string
        default: ""
  - name: TKG_HTTPS_PROXY
    schema:
      openAPIV3Schema:
        type: string
        default: ""
  - name: TKG_NO_PROXY
    schema:
      openAPIV3Schema:
        type: string
        default: ""
  patches:
  - name: vsphereClusterTemplate
    definitions:
    - selector:
        apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
        kind: VSphereClusterTemplate
        matchResources:
          infrastructureCluster: true
      jsonPatches:
      - op: replace
        path: /spec/template/spec/controlPlaneEndpoint/host
        valueFrom:
          variable: VSPHERE_CONTROL_PLANE_ENDPOINT
      - op: replace
        path: /spec/template/spec/thumbprint
        valueFrom:
          variable: VSPHERE_TLS_THUMBPRINT
      - op: replace
        path: /spec/template/spec/server
        valueFrom:
          variable: VSPHERE_SERVER
  - name: controlPlaneMachineTemplate
    definitions:
    - selector:
        apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
        kind: VSphereMachineTemplate
        matchResources:
          controlPlane: true
      jsonPatches:
      - op: replace
        path: /spec/template/spec/numCPUs
        valueFrom:
          variable: VSPHERE_CONTROL_PLANE_NUM_CPUS
      - op: replace
        path: /spec/template/spec/diskGiB
        valueFrom:
          variable: VSPHERE_CONTROL_PLANE_DISK_GIB
      - op: replace
        path: /spec/template/spec/memoryMiB
        valueFrom:
          variable: VSPHERE_CONTROL_PLANE_MEM_MIB
      - op: replace
        path: /spec/template/spec/cloneMode
        valueFrom:
          variable: VSPHERE_CLONE_MODE
      - op: replace
        path: /spec/template/spec/network
        valueFrom:
          variable: VSPHERE_NETWORK
      - op: replace
        path: /spec/template/spec/template
        valueFrom:
          variable: VSPHERE_TEMPLATE
      - op: replace
        path: /spec/template/spec/datacenter
        valueFrom:
          variable: VSPHERE_DATACENTER
      - op: replace
        path: /spec/template/spec/datastore
        valueFrom:
          variable: VSPHERE_DATASTORE
      - op: replace
        path: /spec/template/spec/folder
        valueFrom:
          variable: VSPHERE_FOLDER
      - op: replace
        path: /spec/template/spec/resourcePool
        valueFrom:
          variable: VSPHERE_RESOURCE_POOL
      - op: replace
        path: /spec/template/spec/storagePolicyName
        valueFrom:
          variable: VSPHERE_STORAGE_POLICY_ID
      - op: replace
        path: /spec/template/spec/server
        valueFrom:
          variable: VSPHERE_SERVER
  - name: workerMachineTemplate
    definitions:
    - selector:
        apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
        kind: VSphereMachineTemplate
        matchResources:
          machineDeploymentClass:
            names:
            - tkg-worker
      jsonPatches:
      - op: replace
        path: /spec/template/spec/numCPUs
        valueFrom:
          variable: VSPHERE_WORKER_NUM_CPUS
      - op: replace
        path: /spec/template/spec/diskGiB
        valueFrom:
          variable: VSPHERE_WORKER_DISK_GIB
      - op: replace
        path: /spec/template/spec/memoryMiB
        valueFrom:
          variable: VSPHERE_WORKER_MEM_MIB
      - op: replace
        path: /spec/template/spec/cloneMode
        valueFrom:
          variable: VSPHERE_CLONE_MODE
      - op: replace
        path: /spec/template/spec/network
        valueFrom:
          variable: VSPHERE_NETWORK
      - op: replace
        path: /spec/template/spec/template
        valueFrom:
          variable: VSPHERE_TEMPLATE
      - op: replace
        path: /spec/template/spec/datacenter
        valueFrom:
          variable: VSPHERE_DATACENTER
      - op: replace
        path: /spec/template/spec/datastore
        valueFrom:
          variable: VSPHERE_DATASTORE
      - op: replace
        path: /spec/template/spec/folder
        valueFrom:
          variable: VSPHERE_FOLDER
      - op: replace
        path: /spec/template/spec/resourcePool
        valueFrom:
          variable: VSPHERE_RESOURCE_POOL
      - op: replace
        path: /spec/template/spec/storagePolicyName
        valueFrom:
          variable: VSPHERE_STORAGE_POLICY_ID
      - op: replace
        path: /spec/template/spec/server
        valueFrom:
          variable: VSPHERE_SERVER
  - name: kubeadmControlPlaneTemplate
    definitions:
    - selector:
        apiVersion: controlplane.cluster.x-k8s.io/v1beta1
        kind: KubeadmControlPlaneTemplate
        matchResources:
          controlPlane: true
      jsonPatches:
      - op: replace
        path: /spec/template/spec/kubeadmConfigSpec/users
        valueFrom:
          template: |
            - name: capv
              sshAuthorizedKeys:
              - '{{.VSPHERE_SSH_AUTHORIZED_KEY}}'
              sudo: ALL=(ALL) NOPASSWD:ALL
      - op: replace
        path: /spec/template/spec/replicas
        valueFrom:
          variable: CONTROL_PLANE_MACHINE_COUNT
  - name: KubeadmConfigTemplate
    definitions:
    - selector:
        apiVersion: bootstrap.cluster.x-k8s.io/v1beta1
        kind: KubeadmConfigTemplate
        matchResources:
          machineDeploymentClass:
            names:
            - tkg-worker
      jsonPatches:
      - op: replace
        path: /spec/template/spec/users
        valueFrom:
          template: |
            - name: capv
              sshAuthorizedKeys:
              - '{{.VSPHERE_SSH_AUTHORIZED_KEY}}'
              sudo: ALL=(ALL) NOPASSWD:ALL
  - name: httpProxy
    enabledIf: '{{ if eq "" .TKG_HTTP_PROXY}}false{{else}}true{{end}}'
    definitions:
    - selector:
        apiVersion: controlplane.cluster.x-k8s.io/v1beta1
        kind: KubeadmControlPlaneTemplate
        matchResources:
          controlPlane: true
      jsonPatches:
      - op: add
        path: /spec/template/spec/kubeadmConfigSpec/files
        valueFrom:
          template: |
            - content: |
                [Service]
                Environment="HTTP_PROXY={{.TKG_HTTP_PROXY}}"
                Environment="HTTPS_PROXY={{.TKG_HTTPS_PROXY}}"
                Environment="NO_PROXY={{.TKG_NO_PROXY}}"
              owner: root:root
              path: /etc/systemd/system/containerd.service.d/http-proxy.conf
              permissions: "0640"
      - op: add
        path: /spec/template/spec/kubeadmConfigSpec/files
        valueFrom:
          template: |
            - content: |
                [Service]
                Environment="HTTP_PROXY={{.TKG_HTTP_PROXY}}"
                Environment="HTTPS_PROXY={{.TKG_HTTPS_PROXY}}"
                Environment="NO_PROXY={{.TKG_NO_PROXY}}"
              owner: root:root
              path: /usr/lib/systemd/system/kubelet.service.d/http-proxy.conf
              permissions: "0640"
      - op: add
        path: /spec/template/spec/kubeadmConfigSpec/preKubeadmCommands
        valueFrom:
          template: |
            - systemctl daemon-reload
            - systemctl stop containerd
            - systemctl start containerd
            - export HTTP_PROXY={{.TKG_HTTP_PROXY}}
            - export HTTPS_PROXY={{.TKG_HTTPS_PROXY}}
            - export NO_PROXY={{.TKG_NO_PROXY}}
    - selector:
        apiVersion: bootstrap.cluster.x-k8s.io/v1beta1
        kind: KubeadmConfigTemplate
        matchResources:
          machineDeploymentClass:
            names:
            - tkg-worker
      jsonPatches:
      - op: add
        path: /spec/template/spec/files
        valueFrom:
          template: |
            - content: |
                [Service]
                Environment="HTTP_PROXY={{.TKG_HTTP_PROXY}}"
                Environment="HTTPS_PROXY={{.TKG_HTTPS_PROXY}}"
                Environment="NO_PROXY={{.TKG_NO_PROXY}}"
              owner: root:root
              path: /etc/systemd/system/containerd.service.d/http-proxy.conf
              permissions: "0640"
            - content: |
                [Service]
                Environment="HTTP_PROXY={{.TKG_HTTP_PROXY}}"
                Environment="HTTPS_PROXY={{.TKG_HTTPS_PROXY}}"
                Environment="NO_PROXY={{.TKG_NO_PROXY}}"
              owner: root:root
              path: /usr/lib/systemd/system/kubelet.service.d/http-proxy.conf
              permissions: "0640"
      - op: add
        path: /spec/template/spec/preKubeadmCommands
        valueFrom:
          template: |
            - systemctl daemon-reload
            - systemctl restart containerd
            - export HTTP_PROXY={{.TKG_HTTP_PROXY}}
            - export HTTPS_PROXY={{.TKG_HTTPS_PROXY}}
            - export NO_PROXY={{.TKG_NO_PROXY}}
